<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>QR_studio</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://unpkg.com"/>
<!-- Preload both libs so first generation is fast -->
<link rel="preload" href="https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js" as="script"/>
<link rel="preload" href="https://unpkg.com/@zxing/library@0.19.1/umd/index.min.js" as="script"/>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;500;600;700;800&display=swap"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --a:#b8f400;
  --a10:rgba(184,244,0,.10);
  --a20:rgba(184,244,0,.20);
  --dark:#090b08;
  --card:#0f1210;
  --card2:#131714;
  --bord:rgba(184,244,0,.09);
  --bord2:rgba(255,255,255,.06);
  --mut:rgba(255,255,255,.30);
  --danger:#ff4455;
  --warn:#ffa040;
}
html{scroll-behavior:smooth}
body{background:var(--dark);color:#e4ebe0;font-family:'Syne',sans-serif;min-height:100vh;overflow-x:hidden}
::-webkit-scrollbar{width:3px}
::-webkit-scrollbar-thumb{background:var(--bord);border-radius:2px}

input,textarea,select{
  font-family:inherit;background:rgba(255,255,255,.025);
  border:1px solid var(--bord2);border-radius:8px;
  color:#e4ebe0;padding:9px 12px;font-size:14px;width:100%;
  outline:none;transition:border-color .15s,box-shadow .15s;
}
input:focus,textarea:focus,select:focus{border-color:var(--a);box-shadow:0 0 0 3px rgba(184,244,0,.06)}
input::placeholder,textarea::placeholder{color:rgba(255,255,255,.16)}
option{background:#141a12}
textarea{resize:vertical;min-height:68px}
button{cursor:pointer;font-family:inherit;border:none;transition:all .15s}
button:active{transform:scale(.96)}
input[type=range]{padding:0;background:none;border:none;accent-color:var(--a);cursor:pointer;height:4px}
input[type=range]:focus{box-shadow:none;border:none}
input[type=color]{padding:2px;border:none;background:none;cursor:pointer;width:100%;height:100%}
input.err{border-color:rgba(255,68,85,.5)!important;box-shadow:0 0 0 3px rgba(255,68,85,.06)!important}

@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}
@keyframes toastIn{from{opacity:0;transform:translateX(28px)}to{opacity:1;transform:none}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.25}}
@keyframes scanline{0%{top:-4px}100%{top:calc(100% + 4px)}}
@keyframes spin{to{transform:rotate(360deg)}}

header{
  position:sticky;top:0;z-index:100;
  border-bottom:1px solid var(--bord);
  background:rgba(9,11,8,.92);
  backdrop-filter:blur(20px);
  padding:0 24px;
}
.hdr-inner{max-width:1100px;margin:0 auto;height:54px;display:flex;align-items:center;justify-content:space-between}
.logo{display:flex;align-items:center;gap:9px;text-decoration:none}
.logo-box{width:28px;height:28px;background:var(--a);border-radius:6px;display:grid;place-items:center;font-size:13px;flex-shrink:0}
.logo-name{font-family:'Space Mono',monospace;font-weight:700;font-size:16px;letter-spacing:-1px;color:#e4ebe0}
.logo-name span{color:var(--a)}
.hdr-badges{display:flex;gap:6px;align-items:center}
.hdr-badge{font-family:'Space Mono',monospace;font-size:10px;color:rgba(184,244,0,.45);letter-spacing:2px;border:1px solid var(--bord);padding:4px 10px;border-radius:20px}
.hdr-badge.v6{color:rgba(255,160,64,.6);border-color:rgba(255,160,64,.2)}

.main{max-width:1100px;margin:0 auto;padding:24px 24px 60px}
.grid{display:grid;grid-template-columns:1fr 380px;gap:16px;align-items:start}
@media(max-width:860px){.grid{grid-template-columns:1fr}}

.sec{background:var(--card);border:1px solid var(--bord);border-radius:14px;padding:20px}
.sec+.sec{margin-top:14px}
.sec-label{font-family:'Space Mono',monospace;font-size:9px;font-weight:700;color:rgba(184,244,0,.38);letter-spacing:3px;text-transform:uppercase;margin-bottom:16px}

.type-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:5px;margin-bottom:0}
@media(max-width:600px){.type-grid{grid-template-columns:repeat(4,1fr)}}
.type-btn{display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px 4px;border-radius:9px;border:1px solid var(--bord2);background:transparent;color:var(--mut);font-size:11px;font-weight:600}
.type-btn .ico{font-size:16px}
.type-btn.on{border-color:var(--a);background:var(--a10);color:var(--a)}
.type-btn:hover:not(.on){border-color:rgba(255,255,255,.12);color:rgba(255,255,255,.6)}

.lbl{font-family:'Space Mono',monospace;font-size:10px;font-weight:700;color:rgba(255,255,255,.24);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:5px}
.fld{margin-bottom:12px}
.fld:last-child{margin-bottom:0}
.fld-err{font-size:10px;color:var(--danger);font-family:'Space Mono',monospace;margin-top:3px;display:none}
.fld-err.show{display:block}
.two{display:grid;grid-template-columns:1fr 1fr;gap:10px}

.ctabs{display:flex;gap:2px;background:rgba(255,255,255,.025);border:1px solid rgba(255,255,255,.05);border-radius:8px;padding:3px;margin-bottom:16px}
.ctab{flex:1;padding:6px 0;border-radius:6px;border:none;font-family:'Space Mono',monospace;font-size:10px;font-weight:700;background:transparent;color:rgba(255,255,255,.26);text-transform:uppercase;letter-spacing:1px}
.ctab.on{background:var(--a);color:var(--dark)}

.shape-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:16px}
.shape-btn{padding:9px 5px;border-radius:9px;border:1px solid var(--bord2);background:rgba(255,255,255,.02);color:rgba(255,255,255,.34);font-size:11px;font-weight:600}
.shape-btn.on{border-color:var(--a);background:var(--a10);color:var(--a)}
.eye-row{display:flex;gap:6px}
.eye-btn{flex:1;padding:9px 5px;border-radius:9px;border:1px solid var(--bord2);background:rgba(255,255,255,.02);color:rgba(255,255,255,.34);font-size:11px;font-weight:600}
.eye-btn.on{border-color:var(--a);background:var(--a10);color:var(--a)}

.tpl-row{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:16px}
.tpl{display:flex;align-items:center;gap:5px;padding:5px 10px;border-radius:7px;border:1px solid var(--bord2);background:rgba(255,255,255,.02);color:rgba(255,255,255,.4);font-size:11px;font-weight:600}
.tpl:hover{border-color:rgba(255,255,255,.18)}
.c-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.c-lbl{font-size:13px;color:var(--mut)}
.c-ctrl{display:flex;align-items:center;gap:7px}
.swatch{width:28px;height:28px;border-radius:5px;border:2px solid rgba(255,255,255,.1);position:relative;overflow:hidden;cursor:pointer;flex-shrink:0}
.hex{width:78px;font-size:12px;font-family:'Space Mono',monospace;padding:4px 7px}
.tog-row{display:flex;align-items:center;gap:9px;margin-bottom:10px}
.tog{width:34px;height:18px;border-radius:9px;background:rgba(255,255,255,.08);position:relative;cursor:pointer;transition:background .18s;flex-shrink:0;border:none;padding:0;display:block}
.tog.on{background:var(--a)}
.tog-k{position:absolute;top:2px;left:2px;width:14px;height:14px;border-radius:50%;background:#fff;transition:left .18s;pointer-events:none}
.tog.on .tog-k{left:18px}
.tog-lbl{font-size:13px;color:var(--mut);cursor:pointer;user-select:none}

/* gradient danger gate */
.grad-warn{
  margin-top:8px;padding:10px 12px;border-radius:8px;
  border:1px solid rgba(255,160,64,.3);background:rgba(255,160,64,.06);
  font-size:11px;color:rgba(255,160,64,.8);line-height:1.6;
}
.grad-warn strong{color:var(--warn)}
.btn-grad-off{
  margin-top:8px;width:100%;padding:8px;border-radius:7px;
  border:1px solid rgba(255,160,64,.4);background:transparent;
  color:var(--warn);font-size:11px;font-weight:700;font-family:'Space Mono',monospace;
}

.ec-row{display:flex;gap:6px;margin-bottom:5px}
.ecb{flex:1;padding:8px 0;border-radius:7px;border:1px solid var(--bord2);background:rgba(255,255,255,.02);color:rgba(255,255,255,.34);font-weight:700;font-size:13px;font-family:'Space Mono',monospace}
.ecb.on{border-color:var(--a);background:var(--a);color:var(--dark)}
.ecb.clamped{border-color:rgba(184,244,0,.4);color:var(--a)}
.ec-hint{font-size:10px;color:rgba(255,255,255,.16);font-family:'Space Mono',monospace;margin-bottom:18px}
.logo-up{width:100%;padding:16px;border-radius:9px;background:var(--a10);cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:6px;color:var(--a);outline:2px dashed var(--bord);border:none}
.logo-up:hover{background:var(--a20)}
.logo-prev{display:flex;align-items:center;gap:10px}
.logo-img{width:44px;height:44px;object-fit:contain;border-radius:7px;border:1px solid rgba(255,255,255,.08);background:#fff}
.logo-rm{width:26px;height:26px;border-radius:5px;border:none;background:rgba(255,68,85,.12);color:var(--danger);display:grid;place-items:center;font-size:16px;flex-shrink:0}

/* QR stats bar */
.qr-stats{
  display:flex;gap:6px;flex-wrap:wrap;margin-bottom:14px;
}
.stat-chip{
  padding:4px 9px;border-radius:6px;background:rgba(255,255,255,.025);
  border:1px solid rgba(255,255,255,.06);
  font-family:'Space Mono',monospace;font-size:10px;color:rgba(255,255,255,.3);
  display:flex;align-items:center;gap:5px;
}
.stat-chip .sv{color:rgba(184,244,0,.7);font-weight:700}
.stat-chip.warn .sv{color:var(--warn)}
.stat-chip.bad .sv{color:var(--danger)}

/* print DPI calculator */
.dpi-wrap{
  margin-top:14px;padding:12px;border-radius:9px;
  background:rgba(255,255,255,.018);border:1px solid var(--bord2);
}
.dpi-title{font-family:'Space Mono',monospace;font-size:9px;font-weight:700;color:rgba(255,255,255,.22);letter-spacing:2px;text-transform:uppercase;margin-bottom:10px}
.dpi-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px}
.dpi-result{
  padding:8px 10px;border-radius:7px;font-size:11px;
  font-family:'Space Mono',monospace;line-height:1.6;
}
.dpi-result.ok{background:var(--a10);border:1px solid var(--bord);color:rgba(184,244,0,.7)}
.dpi-result.warn{background:rgba(255,160,64,.06);border:1px solid rgba(255,160,64,.2);color:rgba(255,160,64,.8)}
.dpi-result.bad{background:rgba(255,68,85,.06);border:1px solid rgba(255,68,85,.2);color:rgba(255,68,85,.8)}

.scan-box{margin-top:14px;padding:13px 15px;border-radius:9px;border:1px solid}
.scan-box.good{border-color:rgba(184,244,0,.22);background:rgba(184,244,0,.04)}
.scan-box.caution{border-color:rgba(255,160,64,.22);background:rgba(255,160,64,.04)}
.scan-box.bad{border-color:rgba(255,68,85,.22);background:rgba(255,68,85,.04)}
.scan-hdr{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.scan-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.scan-title{font-family:'Space Mono',monospace;font-size:10px;font-weight:700;letter-spacing:1px}
.scan-items{display:flex;flex-direction:column;gap:4px}
.scan-item{font-size:11px;color:rgba(255,255,255,.36);display:flex;align-items:flex-start;gap:6px;line-height:1.5}

.qz-notice{margin-top:10px;padding:8px 10px;border-radius:7px;background:rgba(184,244,0,.04);border:1px solid var(--bord);font-size:11px;color:rgba(255,255,255,.3);line-height:1.6}
.qz-notice strong{color:rgba(184,244,0,.6);font-weight:600}

/* preview */
.preview-wrap{position:sticky;top:68px}
.prev-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.prev-title{font-family:'Space Mono',monospace;font-size:9px;font-weight:700;color:rgba(184,244,0,.38);letter-spacing:3px;text-transform:uppercase}

#qr-mount{
  display:flex;justify-content:center;align-items:center;
  min-height:280px;border-radius:11px;overflow:hidden;
  width:min(400px,100%);margin:0 auto 14px;
  transition:box-shadow .25s,background .25s;
  position:relative;
}
#qr-mount.empty{background:rgba(255,255,255,.018);outline:2px dashed var(--bord)}
#qr-mount.pass{box-shadow:0 0 0 2px var(--a),0 0 32px rgba(184,244,0,.10)}
#qr-mount.fail{box-shadow:0 0 0 2px var(--danger),0 0 32px rgba(255,68,85,.08)}

.scanline-wrap{position:absolute;inset:0;pointer-events:none;overflow:hidden;border-radius:11px}
.scanline{position:absolute;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--a),transparent);animation:scanline 1.2s ease-in-out infinite;opacity:.7}

/* low-light simulate overlay */
#qr-mount.lowlight canvas,#qr-mount.lowlight svg{filter:brightness(0.28) saturate(0.2) contrast(1.1)}

.empty-hint{text-align:center;color:rgba(184,244,0,.16)}
.empty-hint .big{font-size:48px;margin-bottom:10px;filter:grayscale(1)}
.empty-hint .txt{font-size:11px;font-family:'Space Mono',monospace;letter-spacing:1px}

.vbadge{font-size:10px;font-family:'Space Mono',monospace;display:flex;align-items:center;gap:5px}
.vbadge.pass{color:var(--a)}
.vbadge.fail{color:var(--danger)}
.vbadge.loading{color:rgba(255,255,255,.22)}
.vbadge.checking{color:rgba(184,244,0,.45)}

.dl-row{display:flex;gap:7px;margin-bottom:7px}
.btn-main{flex:1;padding:10px 0;border-radius:9px;border:none;background:var(--a);color:var(--dark);font-weight:700;font-size:13px;font-family:'Syne',sans-serif}
.btn-out{flex:1;padding:10px 0;border-radius:9px;border:1px solid var(--bord);background:transparent;color:var(--a);font-weight:700;font-size:13px}
.cp-row{display:flex;gap:7px;margin-bottom:7px}
.btn-g{flex:1;padding:8px 0;border-radius:9px;border:1px solid var(--bord2);background:rgba(255,255,255,.02);color:rgba(255,255,255,.34);font-size:12px;font-weight:600}
.btn-g.done{background:var(--a10);color:var(--a)}
.btn-g.active{border-color:rgba(184,244,0,.4);color:rgba(184,244,0,.6)}
.data-chip{padding:8px 10px;border-radius:7px;background:rgba(0,0,0,.28);border:1px solid rgba(255,255,255,.05);font-size:10px;font-family:'Space Mono',monospace;color:rgba(255,255,255,.2);word-break:break-all;max-height:48px;overflow-y:auto;line-height:1.6}
.cam-tip{margin-top:12px;padding:10px 12px;border-radius:8px;border:1px solid var(--bord);background:var(--a10);font-size:11px;color:rgba(184,244,0,.55);font-family:'Space Mono',monospace;line-height:1.6;text-align:center}

/* batch */
.batch-drop{
  width:100%;padding:20px;border-radius:9px;
  background:rgba(184,244,0,.03);outline:2px dashed rgba(184,244,0,.15);
  border:none;display:flex;flex-direction:column;align-items:center;gap:6px;
  color:rgba(184,244,0,.5);cursor:pointer;
}
.batch-drop:hover{background:var(--a10);outline-color:rgba(184,244,0,.3)}
.batch-drop .ico{font-size:24px}
.batch-drop .txt{font-size:12px;font-family:'Space Mono',monospace}
.batch-drop .sub{font-size:10px;color:rgba(255,255,255,.2)}
.batch-progress{margin-top:12px;padding:12px;border-radius:9px;background:rgba(255,255,255,.02);border:1px solid var(--bord2)}
.batch-bar-wrap{height:4px;border-radius:2px;background:rgba(255,255,255,.06);overflow:hidden;margin:8px 0}
.batch-bar{height:100%;background:var(--a);border-radius:2px;transition:width .2s}
.batch-txt{font-family:'Space Mono',monospace;font-size:10px;color:rgba(255,255,255,.3)}
.batch-dl{
  width:100%;margin-top:10px;padding:9px;border-radius:8px;
  border:none;background:var(--a);color:var(--dark);font-weight:700;font-size:12px;font-family:'Syne',sans-serif;
}

#toasts{position:fixed;top:66px;right:18px;z-index:9999;display:flex;flex-direction:column;gap:7px;pointer-events:none}
.toast{padding:10px 15px;border-radius:10px;font-size:12px;font-weight:600;animation:toastIn .2s ease;display:flex;align-items:center;gap:7px;backdrop-filter:blur(16px);pointer-events:all}
.toast.ok{background:rgba(184,244,0,.13);border:1px solid rgba(184,244,0,.22);color:var(--a)}
.toast.er{background:rgba(255,68,85,.13);border:1px solid rgba(255,68,85,.22);color:var(--danger)}
.toast.wn{background:rgba(255,160,64,.13);border:1px solid rgba(255,160,64,.22);color:var(--warn)}

/* lowlight toggle button */
.btn-ll{padding:8px 0;border-radius:9px;border:1px solid var(--bord2);background:rgba(255,255,255,.02);color:rgba(255,255,255,.34);font-size:11px;font-weight:700;font-family:'Space Mono',monospace;width:100%;margin-bottom:7px}
.btn-ll.on{border-color:rgba(255,160,64,.4);background:rgba(255,160,64,.06);color:var(--warn)}
</style>
</head>
<body>
<div id="root"></div>
<div id="toasts"></div>

<script>
"use strict";
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   QR STUDIO v6 â€” Phone-camera optimized. Encode-first. Verify-correct.

   Key fixes over v5:
   [1]  qrcode.js (~25KB) as primary encoder â€” qr-code-styling lazy-loads for styling only
   [2]  MultiFormatReader + BinaryBitmap + HTMLCanvasImageSource â€” true zero-copy verify
   [3]  Proportional quiet zone â€” 4 Ã— moduleWidth px, not fixed 16px
   [4]  devicePixelRatio canvas output â€” crisp on Retina / HiDPI
   [5]  Verify re-runs on every option change, not just data changes
   [6]  Live QR version + byte count stats bar
   [7]  Print DPI calculator with module-size validation
   [8]  Low-light preview toggle (simulate worst-case phone camera)
   [9]  RFC 6350 vCard field validation with inline errors
   [10] Gradient hard gate â€” warns + confirm before generating
   [11] Batch CSV generation â†’ ZIP download (JSZip)
   [12] Real finder-pattern contrast check on rendered canvas pixels
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ Script loader â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const _sc = new Map();
function loadScript(src) {
  if (_sc.has(src)) return _sc.get(src);
  const p = new Promise((ok, fail) => {
    const s = document.createElement("script");
    s.src = src; s.onload = ok;
    s.onerror = () => { _sc.delete(src); fail(new Error("Load failed: " + src)); };
    document.head.appendChild(s);
  });
  _sc.set(src, p); return p;
}

/* â”€â”€ Primary encoder: qrcode.js â€” fast, tiny â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let _qrP = null;
function ensureQR() {
  if (!_qrP) _qrP = loadScript("https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js")
    .then(() => { if (!window.QRCode) throw new Error("QRCode not found"); return window.QRCode; });
  return _qrP;
}

/* â”€â”€ Styling library: lazy-loaded only when needed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let _styP = null;
function ensureStyling() {
  if (!_styP) _styP = loadScript("https://unpkg.com/qr-code-styling@1.6.0-rc.1/lib/qr-code-styling.js")
    .then(() => { if (!window.QRCodeStyling) throw new Error("QRCodeStyling not found"); return window.QRCodeStyling; });
  return _styP;
}

/* â”€â”€ ZXing: verify only â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let _zxP = null;
function ensureZXing() {
  if (!_zxP) _zxP = loadScript("https://unpkg.com/@zxing/library@0.19.1/umd/index.min.js")
    .then(() => { if (!window.ZXing) throw new Error("ZXing unavailable"); return window.ZXing; })
    .catch(e => { _zxP = null; throw e; });
  return _zxP;
}

/* â”€â”€ JSZip: batch only â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let _zipP = null;
function ensureJSZip() {
  if (!_zipP) _zipP = loadScript("https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js")
    .then(() => { if (!window.JSZip) throw new Error("JSZip not found"); return window.JSZip; });
  return _zipP;
}

/* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function toast(msg, type = "ok", ms = 2600) {
  const c = document.getElementById("toasts");
  const el = document.createElement("div");
  el.className = "toast " + type;
  el.innerHTML = `<span>${{ok:"âœ“",er:"âœ•",wn:"âš "}[type]||"â€¢"}</span><span>${msg}</span>`;
  c.appendChild(el);
  setTimeout(() => { el.style.cssText = "opacity:0;transform:translateX(28px);transition:.18s"; setTimeout(() => el.remove(), 220); }, ms);
}

/* â”€â”€ QR spec: version lookup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
// QR capacity table (byte mode, error correction level)
// Source: ISO/IEC 18004:2015 Table 9
const QR_CAP = {
  L:[17,32,53,78,106,134,154,192,230,271,321,367,425,458,520,586,644,718,792,858,929,1003,1091,1171,1273,1367,1465,1528,1628,1732,1840,1952,2068,2188,2303,2431,2563,2699,2809,2953],
  M:[14,26,42,62,84,106,122,152,180,213,251,287,331,362,412,450,504,560,624,666,711,779,857,911,997,1059,1125,1190,1264,1370,1452,1538,1628,1722,1809,1911,1989,2099,2213,2331],
  Q:[11,20,32,46,60,74,86,108,130,151,177,203,241,258,292,322,364,394,442,482,509,565,611,661,715,751,805,868,908,982,1030,1112,1168,1228,1283,1351,1423,1499,1579,1663],
  H:[7,14,24,34,44,58,64,84,98,119,137,155,177,194,220,250,280,310,338,382,403,439,461,511,535,593,625,658,698,742,790,842,898,958,983,1051,1093,1139,1219,1273]
};
function getQRVersion(byteLen, ec) {
  const caps = QR_CAP[ec] || QR_CAP.H;
  for (let i = 0; i < caps.length; i++) { if (caps[i] >= byteLen) return i + 1; }
  return 40;
}
// Module count for a given version: 4*v + 17
function moduleCount(v) { return 4 * v + 17; }
// Proportional quiet zone: 4 modules at current pixel density
function quietZonePx(v, canvasSize) {
  const mc = moduleCount(v);
  const pxPerModule = canvasSize / mc;
  return Math.ceil(4 * pxPerModule);
}

/* â”€â”€ vCard field validation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function validateFields(type, fields) {
  const errs = {};
  if (type === "email" || type === "vcard") {
    const e = (fields.email || "").trim();
    if (e && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)) errs.email = "Invalid email format";
  }
  if (type === "url") {
    const u = (fields.url || "").trim();
    if (u && !/^(https?:\/\/)?[\w\-]+(\.[\w\-]+)+/.test(u)) errs.url = "Looks like an invalid URL";
  }
  if (type === "wifi") {
    if (!(fields.ssid || "").trim()) errs.ssid = "SSID is required";
  }
  if (type === "vcard") {
    if (!(fields.firstName || "").trim() && !(fields.lastName || "").trim()) {
      errs.firstName = "At least one name field required";
    }
  }
  return errs; // {} means valid
}

/* â”€â”€ RFC 6350-correct vCard escaping â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
// Text fields (NOTE, ADR, ORG, FN, N): escape \ ; , "
// Non-text fields (TEL, EMAIL, URL): no escaping, just whitespace trim
function vcEscText(v) {
  return (v||"").replace(/\\/g,"\\\\").replace(/;/g,"\\;").replace(/,/g,"\\,");
}
// TEL: preserve +, digits, spaces, parens, hyphens, dots â€” RFC 3966
function vcTel(v) { return (v||"").replace(/[^\d+\-().\s]/g,"").trim(); }
// WiFi: escape : ; , "
function wfEsc(v) { return (v||"").replace(/\\/g,"\\\\").replace(/:/g,"\\:").replace(/;/g,"\\;").replace(/,/g,"\\,"); }

/* â”€â”€ Data builder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function buildData(type, f) {
  switch (type) {
    case "url": {
      let u = (f.url || "").trim();
      if (u && !/^https?:\/\//i.test(u)) u = "https://" + u;
      return u;
    }
    case "text":  return f.text || "";
    case "email": return `mailto:${(f.email||"").trim()}?subject=${encodeURIComponent(f.subject||"")}&body=${encodeURIComponent(f.body||"")}`;
    case "sms":   return `sms:${(f.phone||"").trim()}${f.message?`?body=${encodeURIComponent(f.message)}`:""}`;
    case "phone": return `tel:${vcTel(f.phone)}`;
    case "wifi":  return `WIFI:T:${f.security||"WPA"};S:${wfEsc(f.ssid)};P:${wfEsc(f.password)};;`;
    case "vcard": {
      const fn = [f.firstName, f.lastName].filter(Boolean).map(vcEscText).join(" ");
      return [
        "BEGIN:VCARD","VERSION:3.0",
        `FN:${fn}`,
        `N:${vcEscText(f.lastName||"")};${vcEscText(f.firstName||"")};;;`,
        `ORG:${vcEscText(f.org||"")}`,
        `TEL:${vcTel(f.phone)}`,
        `EMAIL:${(f.email||"").trim()}`,
        `URL:${(f.website||"").trim()}`,
        `ADR:;;${vcEscText(f.address||"")};;;;`,
        "END:VCARD"
      ].join("\n");
    }
    default: return "";
  }
}

/* â”€â”€ Contrast math â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function expandHex(hex) {
  hex=(hex||"").trim().replace(/^#/,"");
  if(hex.length===3) hex=hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];
  return hex.length===6?"#"+hex:null;
}
function hexLum(hex) {
  const h=expandHex(hex); if(!h) return 0;
  const r=parseInt(h.slice(1,3),16)/255,g=parseInt(h.slice(3,5),16)/255,b=parseInt(h.slice(5,7),16)/255;
  const lin=x=>x<=0.03928?x/12.92:Math.pow((x+0.055)/1.055,2.4);
  return 0.2126*lin(r)+0.7152*lin(g)+0.0722*lin(b);
}
function cr(fg,bg){
  const l1=hexLum(fg),l2=hexLum(bg);
  return(Math.max(l1,l2)+0.05)/(Math.min(l1,l2)+0.05);
}

/* â”€â”€ Canvas-pixel finder-pattern contrast check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
// Samples the top-left 7x7 finder pattern and checks dark/light module contrast
// Returns {ratio, ok} â€” much more accurate than global luminance ratio
function sampleFinderContrast(canvas) {
  try {
    const ctx = canvas.getContext("2d");
    const w = canvas.width, h = canvas.height;
    // Finder is in top-left corner â€” sample a region of ~8% of canvas width
    const sz = Math.floor(w * 0.08);
    const dark = [], light = [];
    for (let y = sz; y < sz*3; y += 2) {
      for (let x = sz; x < sz*3; x += 2) {
        const d = ctx.getImageData(x, y, 1, 1).data;
        const lum = 0.2126*(d[0]/255) + 0.7152*(d[1]/255) + 0.0722*(d[2]/255);
        if (lum < 0.4) dark.push(lum); else light.push(lum);
      }
    }
    if (!dark.length || !light.length) return { ratio: 1, ok: false, sampled: false };
    const avgDark  = dark.reduce((a,b)=>a+b,0)/dark.length;
    const avgLight = light.reduce((a,b)=>a+b,0)/light.length;
    const ratio = (avgLight + 0.05) / (avgDark + 0.05);
    return { ratio, ok: ratio >= 3, sampled: true };
  } catch { return { ratio: 1, ok: false, sampled: false }; }
}

/* â”€â”€ Categorical scan status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function scanStatus(fg, bg, ecLevel, logoSize, dataLen, hasMargin, useGrad, qrVersion, finderOk) {
  const ratio = cr(fg, bg);
  const reasons = [];
  let bad = 0, caution = 0;

  if (ratio < 2.5) { bad++; reasons.push({ sev:"bad", msg:`Contrast ${ratio.toFixed(1)}:1 â€” too low for most phone cameras`}); }
  else if (ratio < 4) { caution++; reasons.push({ sev:"caution", msg:`Contrast ${ratio.toFixed(1)}:1 â€” may fail in poor lighting`}); }

  if (finderOk === false) { bad++; reasons.push({ sev:"bad", msg:"Finder pattern contrast failed pixel-sample â€” scanner will not locate QR"}); }

  if (useGrad) { caution++; reasons.push({ sev:"caution", msg:"Gradient reduces local dot contrast â€” phone cameras prefer solid foreground"}); }

  if (logoSize > 0 && ecLevel === "L") { bad++; reasons.push({ sev:"bad", msg:"Logo with L correction will be unreadable â€” use H"}); }
  else if (logoSize > 0 && ecLevel === "M") { caution++; reasons.push({ sev:"caution", msg:"Logo with M correction is risky â€” use Q or H"}); }
  if (logoSize > 30) { caution++; reasons.push({ sev:"caution", msg:"Logo covers >30% â€” data may be obscured"}); }

  if (qrVersion > 15) { caution++; reasons.push({ sev:"caution", msg:`Version ${qrVersion} QR â€” very dense, test on multiple phone cameras`}); }
  if (qrVersion > 25) { bad++; reasons.push({ sev:"bad", msg:`Version ${qrVersion} QR â€” many phone cameras will fail to decode`}); }

  if (dataLen > 300) { caution++; reasons.push({ sev:"caution", msg:"Long data creates dense modules â€” test carefully on phone"}); }
  if (!hasMargin) { bad++; reasons.push({ sev:"bad", msg:"No quiet zone â€” phone cameras need white border to locate QR"}); }

  const level = bad > 0 ? "bad" : caution > 0 ? "caution" : "good";
  return { level, label:{good:"Camera Ready",caution:"Some Concerns",bad:"Will Likely Fail"}[level], reasons };
}

/* â”€â”€ Print DPI calculator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function calcDPI(qrVersion, printSizeIn, dpi) {
  const mc = moduleCount(qrVersion);
  const totalPx = dpi * printSizeIn;
  const pxPerModule = totalPx / mc;
  const mmPerModule = (pxPerModule / dpi) * 25.4;
  // QR spec min: 0.25mm per module for good print. Practical phone camera min: ~0.33mm
  if (mmPerModule < 0.25) return { level:"bad", msg:`${mmPerModule.toFixed(2)}mm/module â€” below spec minimum (0.25mm)` };
  if (mmPerModule < 0.33) return { level:"warn", msg:`${mmPerModule.toFixed(2)}mm/module â€” marginal, may fail on some cameras` };
  return { level:"ok", msg:`${mmPerModule.toFixed(2)}mm/module â€” camera-readable at this size` };
}

/* â”€â”€ localStorage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function lsGet(k,fb){try{const v=localStorage.getItem(k);return v?JSON.parse(v):fb;}catch{return fb;}}
function lsSet(k,v){try{localStorage.setItem(k,JSON.stringify(v));}catch(e){if(e.name==="QuotaExceededError"||e.code===22)toast("Storage full","wn");}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const S = {
  qrType:    "url",
  fields:    lsGet("qrs_fields_url", {}),
  fieldErrs: {},
  dotType:   "square",
  eyeRadius: "square",
  fgColor:   "#b8f400",
  bgColor:   "#0c0f0a",
  useGrad:   false,
  gradEnd:   "#00ff88",
  ecLevel:   "H",
  logoSrc:   null,
  logoSize:  20,
  hasMargin: true,
  customTab: "style",
  verifyStatus: null,
  hasQR:     false,
  imgCopied: false,
  dataCopied:false,
  lowlight:  false,
  qrVersion: 1,
  finderOk:  null,  // null = not yet sampled
  printSize: 2,     // inches
  printDPI:  300,
  // batch
  batchTab:  false,
  batchProgress: null, // null | { done, total }
  batchBlob: null,
};

let _raf = false;
function update(patch, afterRender) {
  Object.assign(S, typeof patch === "function" ? patch(S) : patch);
  if (!_raf) { _raf=true; requestAnimationFrame(()=>{ render(); _raf=false; if(afterRender) afterRender(); }); }
}

/* â”€â”€ h() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function h(tag, attrs={}, ...kids) {
  const el = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs)) {
    if (v===null||v===undefined||v===false) continue;
    if (k==="class") el.className=v;
    else if (k==="style"&&typeof v==="object") Object.assign(el.style,v);
    else if (k==="value")    el.value=v;
    else if (k==="checked")  el.checked=!!v;
    else if (k==="selected") el.selected=!!v;
    else if (k==="disabled") el.disabled=!!v;
    else if (k.startsWith("on")&&typeof v==="function") el.addEventListener(k.slice(2).toLowerCase(),v);
    else el.setAttribute(k,v);
  }
  for (const c of kids.flat(Infinity)) {
    if (c==null||c===false) continue;
    el.appendChild(typeof c==="string"?document.createTextNode(c):c);
  }
  return el;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   QRController v6
   - qrcode.js primary (fast, ~25KB)
   - qr-code-styling lazy-loaded for custom dot/eye styles
   - Proportional quiet zone
   - HiDPI canvas output
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const QRC = (() => {
  let _styInst = null;
  let _lastSig = null;
  let _obs = null;

  function clampEC(ec, logoSrc, logoSize) {
    if (!logoSrc || logoSize === 0) return ec;
    if (ec === "L") return "H";
    if (ec === "M" && logoSize > 15) return "H";
    if (ec === "M") return "Q";
    return ec;
  }
  function mount() { return document.getElementById("qr-mount"); }

  function sig(o) {
    return [o.data,o.dotType,o.eyeRadius,o.fgColor,o.bgColor,o.useGrad,o.gradEnd,o.ecLevel,o.logoSrc?"y":"n",o.logoSize,o.hasMargin].join("|");
  }

  function waitForCanvas(el) {
    return new Promise(resolve => {
      const existing = el.querySelector("canvas");
      if (existing) { resolve(existing); return; }
      if (_obs) _obs.disconnect();
      _obs = new MutationObserver(() => {
        const c = el.querySelector("canvas");
        if (c) { _obs.disconnect(); _obs=null; resolve(c); }
      });
      _obs.observe(el, { childList:true, subtree:true });
      setTimeout(() => { if(_obs){_obs.disconnect();_obs=null;} resolve(null); }, 3500);
    });
  }

  // Check if current options need the styling library
  function needsStyling(opts) {
    return opts.dotType !== "square" || opts.eyeRadius !== "square" ||
           opts.useGrad || opts.logoSrc;
  }

  async function generate(opts) {
    const el = mount(); if (!el) return;
    const effectiveEC = clampEC(opts.ecLevel, opts.logoSrc, opts.logoSize);
    const s = sig({...opts, ecLevel: effectiveEC});
    if (s === _lastSig) return;
    _lastSig = s;

    update({ verifyStatus: "checking", finderOk: null });

    // Compute QR version upfront for quiet zone
    const byteLen = new TextEncoder().encode(opts.data).length;
    const ver = getQRVersion(byteLen, effectiveEC);
    update({ qrVersion: ver });

    // Canvas size: 4Ã— for HiDPI, min 400
    const dpr = Math.min(window.devicePixelRatio || 1, 3);
    const canvasTarget = Math.max(400, 400 * dpr);
    const qzPx = opts.hasMargin ? quietZonePx(ver, canvasTarget) : 0;

    const useStyling = needsStyling(opts);

    try {
      if (useStyling) {
        // Lazy-load styling lib
        await ensureStyling();
        const qOpts = {
          width: canvasTarget, height: canvasTarget,
          data: opts.data,
          dotsOptions: opts.useGrad
            ? { type: opts.dotType, gradient: { type:"linear", rotation:0.8, colorStops:[{offset:0,color:opts.fgColor},{offset:1,color:opts.gradEnd}] } }
            : { type: opts.dotType, color: opts.fgColor },
          cornersSquareOptions: {
            type: opts.eyeRadius==="dot"?"dot":opts.eyeRadius==="extra-rounded"?"extra-rounded":"square",
            color: opts.fgColor
          },
          cornersDotOptions: { type: opts.eyeRadius==="dot"?"dot":"square", color: opts.fgColor },
          backgroundOptions: { color: opts.bgColor },
          qrOptions: { errorCorrectionLevel: effectiveEC },
          margin: qzPx,
          ...(opts.logoSrc?{ image:opts.logoSrc, imageOptions:{imageSize:opts.logoSize/100,margin:5,crossOrigin:"anonymous"} }:{})
        };
        if (_styInst) {
          _styInst.update(qOpts);
        } else {
          el.innerHTML = ""; _styInst = null;
          _styInst = new window.QRCodeStyling(qOpts);
          _styInst.append(el);
        }
      } else {
        // Fast path: qrcode.js directly, draw to canvas
        const QRCode = await ensureQR();
        el.innerHTML = ""; _styInst = null;

        const canvas = document.createElement("canvas");
        canvas.width = canvasTarget; canvas.height = canvasTarget;
        el.appendChild(canvas);

        await QRCode.toCanvas(canvas, opts.data, {
          errorCorrectionLevel: effectiveEC,
          width: canvasTarget,
          margin: Math.ceil(qzPx / (canvasTarget / moduleCount(ver))), // in modules
          color: { dark: opts.fgColor, light: opts.bgColor }
        });
      }
    } catch(e) {
      toast("QR generation failed: " + e.message, "er");
      update({ verifyStatus: null, hasQR: false });
      return;
    }

    update({ hasQR: true });

    waitForCanvas(el).then(canvas => {
      if (canvas) {
        // Sample finder contrast from rendered pixels
        const fc = sampleFinderContrast(canvas);
        update({ finderOk: fc.sampled ? fc.ok : null });
        autoVerify(opts.data, canvas);
      } else {
        update({ verifyStatus: null });
      }
    });
  }

  function clear() {
    const el = mount(); if (!el) return;
    if (_obs) { _obs.disconnect(); _obs=null; }
    _styInst = null; _lastSig = null;
    el.innerHTML = "";
    update({ verifyStatus:null, hasQR:false, qrVersion:1, finderOk:null });
  }

  function getInstance() { return _styInst; }
  function getClampEC(ec, ls, lsz) { return clampEC(ec, ls, lsz); }
  return { generate, clear, getInstance, clampEC: getClampEC };
})();

/* â”€â”€ autoVerify v6: true zero-copy path â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let _zxMultiReader = null;

async function autoVerify(expectedData, canvas) {
  try {
    update({ verifyStatus: "loading" });
    const ZXing = await ensureZXing();
    update({ verifyStatus: "checking" });

    // Instantiate MultiFormatReader once â€” much lighter than BrowserQRCodeReader
    if (!_zxMultiReader) {
      const hints = new Map();
      hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [ZXing.BarcodeFormat.QR_CODE]);
      hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
      _zxMultiReader = new ZXing.MultiFormatReader();
      _zxMultiReader.setHints(hints);
    }

    // BinaryBitmap directly from canvas â€” zero PNG round-trip
    const lum = new ZXing.HTMLCanvasElementLuminanceSource(canvas);
    const bmp = new ZXing.BinaryBitmap(new ZXing.HybridBinarizer(lum));

    let decoded = null;
    try {
      const result = _zxMultiReader.decode(bmp);
      decoded = result ? result.getText() : null;
    } catch { decoded = null; }

    const passed = decoded === expectedData;
    update({ verifyStatus: passed ? "pass" : "fail" });

    // If verify fails, log decoded vs expected for debugging
    if (!passed && decoded) console.warn("[QR v6] Verify mismatch\nExpected:", expectedData, "\nDecoded:", decoded);
  } catch {
    update({ verifyStatus: null });
  }
}

/* â”€â”€ Batch CSV generation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function runBatch(csvText) {
  const lines = csvText.trim().split(/\r?\n/).filter(l => l.trim());
  if (!lines.length) { toast("CSV is empty", "wn"); return; }

  update({ batchProgress: { done:0, total:lines.length }, batchBlob:null });

  try {
    const [QRCode, JSZip] = await Promise.all([ensureQR(), ensureJSZip()]);
    const zip = new JSZip();

    for (let i = 0; i < lines.length; i++) {
      const row = lines[i].split(",");
      const label = (row[0] || "").trim().replace(/[^\w\-]/g,"_") || `qr_${i+1}`;
      let data = (row[1] || row[0] || "").trim();
      if (!data) continue;
      if (!/^https?:\/\//i.test(data) && /\./.test(data)) data = "https://" + data;

      const canvas = document.createElement("canvas");
      const ver = getQRVersion(new TextEncoder().encode(data).length, S.ecLevel);
      const qzModules = S.hasMargin ? 4 : 0;
      await QRCode.toCanvas(canvas, data, {
        errorCorrectionLevel: S.ecLevel, width: 600,
        margin: qzModules,
        color: { dark: S.fgColor, light: S.bgColor }
      });
      const blob = await new Promise(res => canvas.toBlob(res, "image/png"));
      zip.file(label + ".png", blob);
      update({ batchProgress: { done: i+1, total: lines.length }, batchBlob: null });
      // Yield to UI thread
      await new Promise(r => setTimeout(r, 0));
    }

    const zipBlob = await zip.generateAsync({ type:"blob", compression:"DEFLATE" });
    update({ batchProgress: null, batchBlob: zipBlob });
    toast(`${lines.length} QR codes ready`, "ok");
  } catch(e) {
    toast("Batch failed: " + e.message, "er");
    update({ batchProgress: null });
  }
}

function downloadBatch() {
  if (!S.batchBlob) return;
  const a = document.createElement("a");
  a.href = URL.createObjectURL(S.batchBlob);
  a.download = "qrcodes.zip";
  a.click();
}

/* â”€â”€ Download â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function dlQR(fmt) {
  const inst = QRC.getInstance();
  if (inst) { inst.download({ name:"qrcode", extension:fmt }); return; }
  const c = document.getElementById("qr-mount")?.querySelector("canvas");
  if (!c) { toast("Generate a QR first","wn"); return; }
  if (fmt === "svg") { toast("SVG export requires custom dot styles","wn"); return; }
  const a = document.createElement("a"); a.href = c.toDataURL("image/png"); a.download = "qrcode.png"; a.click();
}

/* â”€â”€ Copy image â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function copyImg() {
  const c = document.getElementById("qr-mount")?.querySelector("canvas");
  if (!c) { toast("Generate a QR first","wn"); return; }
  c.toBlob(async blob => {
    try {
      await navigator.clipboard.write([new ClipboardItem({"image/png":blob})]);
      update({imgCopied:true}); setTimeout(()=>update({imgCopied:false}),2000);
      toast("Image copied","ok");
    } catch { toast("Clipboard denied â€” use Download","er"); }
  });
}

/* â”€â”€ Copy data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function copyData(raw) {
  try {
    await navigator.clipboard.writeText(raw);
    update({dataCopied:true}); setTimeout(()=>update({dataCopied:false}),2000);
    toast("Copied","ok");
  } catch { toast("Clipboard write failed","er"); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONSTANTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const QR_TYPES=[
  {id:"url",label:"URL",icon:"ðŸ”—"},{id:"text",label:"Text",icon:"ðŸ“"},
  {id:"email",label:"Email",icon:"âœ‰ï¸"},{id:"sms",label:"SMS",icon:"ðŸ’¬"},
  {id:"phone",label:"Phone",icon:"ðŸ“ž"},{id:"wifi",label:"WiFi",icon:"ðŸ“¶"},
  {id:"vcard",label:"vCard",icon:"ðŸ‘¤"},
];
const DOT_TYPES=["square","dots","rounded","extra-rounded","classy","classy-rounded"];
const DOT_LABELS={square:"Square",dots:"Dots",rounded:"Rounded","extra-rounded":"X-Round",classy:"Classy","classy-rounded":"Classy+"};
const EYE_RADII=["square","dot","extra-rounded"];
const EYE_LABELS={square:"Square",dot:"Dot","extra-rounded":"Round"};
const EC_LEVELS=["L","M","Q","H"];
const TEMPLATES=[
  {name:"Acid",    bg:"#0c0f0a",fg:"#b8f400"},{name:"Obsidian",bg:"#0d0d0d",fg:"#ffffff"},
  {name:"Blueprint",bg:"#0a1628",fg:"#4da6ff"},{name:"Ember",  bg:"#1a0800",fg:"#ff6b35"},
  {name:"Sakura",  bg:"#1a0d12",fg:"#ff8fab"},{name:"Matrix",  bg:"#001a00",fg:"#00ff41"},
  {name:"Chalk",   bg:"#fafaf8",fg:"#1a1a1a"},{name:"Gold",    bg:"#0f0c00",fg:"#ffd700"},
];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PERSISTENT ELEMENTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const QR_MOUNT = (() => {
  const el = document.createElement("div");
  el.id = "qr-mount"; el.className = "qr-mount empty";
  el.innerHTML = `<div class="empty-hint"><div class="big">â–£</div><div class="txt">Enter data to generate</div></div>`;
  return el;
})();
const FORM_EL = document.createElement("div");
FORM_EL.id = "form-container";

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FORM PATCHING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function patchInput(container, key, label, placeholder, type="text") {
  let wrap = container.querySelector(`[data-key="${key}"]`);
  if (!wrap) {
    wrap = document.createElement("div"); wrap.className="fld"; wrap.setAttribute("data-key",key);
    const lbl = document.createElement("div"); lbl.className="lbl"; lbl.textContent=label;
    const inp = document.createElement("input");
    inp.type=type; inp.placeholder=placeholder;
    const errDiv = document.createElement("div"); errDiv.className="fld-err";
    inp.addEventListener("input", e => {
      const newFields = {...S.fields,[key]:e.target.value};
      const errs = validateFields(S.qrType, newFields);
      update({ fields:newFields, fieldErrs:errs });
      lsSet("qrs_fields_"+S.qrType, newFields);
      scheduleQR(newFields);
    });
    wrap.appendChild(lbl); wrap.appendChild(inp); wrap.appendChild(errDiv);
    container.appendChild(wrap);
  }
  const inp = wrap.querySelector("input");
  const errDiv = wrap.querySelector(".fld-err");
  if (document.activeElement !== inp && inp.value !== (S.fields[key]||"")) inp.value = S.fields[key]||"";
  inp.type=type; inp.placeholder=placeholder;
  wrap.querySelector(".lbl").textContent=label;
  // Show/hide validation error
  const errMsg = S.fieldErrs[key];
  if (errMsg) { inp.classList.add("err"); errDiv.textContent=errMsg; errDiv.classList.add("show"); }
  else { inp.classList.remove("err"); errDiv.textContent=""; errDiv.classList.remove("show"); }
}

function patchTextarea(container, key, label, placeholder) {
  let wrap = container.querySelector(`[data-key="${key}"]`);
  if (!wrap) {
    wrap=document.createElement("div"); wrap.className="fld"; wrap.setAttribute("data-key",key);
    const lbl=document.createElement("div"); lbl.className="lbl"; lbl.textContent=label;
    const ta=document.createElement("textarea"); ta.placeholder=placeholder;
    ta.addEventListener("input", e => {
      const newFields={...S.fields,[key]:e.target.value};
      update({fields:newFields});
      lsSet("qrs_fields_"+S.qrType,newFields);
      scheduleQR(newFields);
    });
    wrap.appendChild(lbl); wrap.appendChild(ta); container.appendChild(wrap);
  }
  const ta=wrap.querySelector("textarea");
  if(document.activeElement!==ta&&ta.value!==(S.fields[key]||"")) ta.value=S.fields[key]||"";
  ta.placeholder=placeholder;
}

function patchSelect(container, key, label, options) {
  let wrap=container.querySelector(`[data-key="${key}"]`);
  if(!wrap){
    wrap=document.createElement("div"); wrap.className="fld"; wrap.setAttribute("data-key",key);
    const lbl=document.createElement("div"); lbl.className="lbl"; lbl.textContent=label;
    const sel=document.createElement("select");
    options.forEach(o=>{const op=document.createElement("option");op.value=op.textContent=o;sel.appendChild(op);});
    sel.addEventListener("change",e=>{const newFields={...S.fields,[key]:e.target.value};update({fields:newFields});lsSet("qrs_fields_"+S.qrType,newFields);scheduleQR(newFields);});
    wrap.appendChild(lbl); wrap.appendChild(sel); container.appendChild(wrap);
  }
  const sel=wrap.querySelector("select");
  sel.value=S.fields[key]||options[0];
}

function buildForm(container) {
  const needed=getNeededKeys(S.qrType);
  [...container.querySelectorAll("[data-key]")].forEach(el=>{if(!needed.includes(el.dataset.key))el.remove();});
  if(S.qrType!=="vcard"){const tc=container.querySelector(".two");if(tc)tc.remove();}
  switch(S.qrType){
    case"url":   patchInput(container,"url","Website URL","https://example.com","url"); break;
    case"text":  patchTextarea(container,"text","Text Content","Any text, code, messageâ€¦"); break;
    case"email": patchInput(container,"email","Email","you@example.com","email"); patchInput(container,"subject","Subject","Subject line"); patchTextarea(container,"body","Body","Messageâ€¦"); break;
    case"sms":   patchInput(container,"phone","Phone Number","+1 555 000 0000","tel"); patchTextarea(container,"message","Message","SMS bodyâ€¦"); break;
    case"phone": patchInput(container,"phone","Phone Number","+1 555 000 0000","tel"); break;
    case"wifi":  patchInput(container,"ssid","Network SSID","MyWiFiNetwork"); patchInput(container,"password","Password","WiFi password","password"); patchSelect(container,"security","Security",["WPA","WPA2","WEP","None"]); break;
    case"vcard":
      let twoCol=container.querySelector(".two");
      if(!twoCol){twoCol=document.createElement("div");twoCol.className="two";container.insertBefore(twoCol,container.firstChild);}
      [...twoCol.querySelectorAll("[data-key]")].forEach(el=>{if(!["firstName","lastName"].includes(el.dataset.key))el.remove();});
      patchInput(twoCol,"firstName","First Name","John");
      patchInput(twoCol,"lastName","Last Name","Doe");
      patchInput(container,"org","Organization","Company Name");
      patchInput(container,"phone","Phone","+1 555 000 0000","tel");
      patchInput(container,"email","Email","john@example.com","email");
      patchInput(container,"website","Website","https://example.com","url");
      patchInput(container,"address","Address","123 Main St, City"); break;
  }
}

function getNeededKeys(type){
  const map={url:["url"],text:["text"],email:["email","subject","body"],sms:["phone","message"],phone:["phone"],wifi:["ssid","password","security"],vcard:["firstName","lastName","org","phone","email","website","address"]};
  return map[type]||[];
}

/* â”€â”€ QR generation scheduling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let _qrTimer=null;
function scheduleQR(fields){
  if(_qrTimer)clearTimeout(_qrTimer);
  _qrTimer=setTimeout(()=>triggerQR(fields),180);
}

function triggerQR(fields) {
  _qrTimer=null;
  const f = fields !== undefined ? fields : S.fields;
  const errs = validateFields(S.qrType, f);
  if (Object.keys(errs).length) { QRC.clear(); return; } // don't generate on invalid data
  const raw = buildData(S.qrType, f);
  if (!raw.trim()) { QRC.clear(); return; }
  QRC.generate({
    data:raw, dotType:S.dotType, eyeRadius:S.eyeRadius,
    fgColor:S.fgColor, bgColor:S.bgColor,
    useGrad:S.useGrad, gradEnd:S.gradEnd,
    ecLevel:S.ecLevel, logoSrc:S.logoSrc,
    logoSize:S.logoSize, hasMargin:S.hasMargin,
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const tog=(on,onClick)=>h("button",{class:"tog"+(on?" on":""),onClick},h("div",{class:"tog-k"}));

function rHeader(){
  return h("header",{},h("div",{class:"hdr-inner"},
    h("div",{class:"logo"},
      h("div",{class:"logo-box"},"â–£"),
      h("div",{class:"logo-name"},"QR",h("span",{},"_"),"studio")
    ),
    h("div",{class:"hdr-badges"},
      h("div",{class:"hdr-badge v6"},"v6"),
      h("div",{class:"hdr-badge"},"ENCODE")
    )
  ));
}

function rTypeSelector(){
  return h("div",{},
    h("div",{class:"sec-label",style:"margin-bottom:12px"},"â—ˆ Content Type"),
    h("div",{class:"type-grid"},
      QR_TYPES.map(t=>h("button",{
        class:"type-btn"+(S.qrType===t.id?" on":""),
        onClick:()=>{
          if(S.qrType===t.id)return;
          const savedFields=lsGet("qrs_fields_"+t.id,{});
          const errs=validateFields(t.id,savedFields);
          update({qrType:t.id,fields:savedFields,fieldErrs:errs},()=>{buildForm(FORM_EL);triggerQR(savedFields);});
        }
      },h("span",{class:"ico"},t.icon),t.label))
    )
  );
}

function rStyleTab(){
  const needsStyling = S.dotType!=="square"||S.eyeRadius!=="square"||S.useGrad||S.logoSrc;
  return h("div",{},
    h("div",{class:"lbl"},"Module Shape"),
    h("div",{class:"shape-grid"},
      DOT_TYPES.map(d=>h("button",{class:"shape-btn"+(S.dotType===d?" on":""),onClick:()=>{update({dotType:d});triggerQR();}},DOT_LABELS[d]))
    ),
    h("div",{class:"lbl"},"Eye Style"),
    h("div",{class:"eye-row"},
      EYE_RADII.map(e=>h("button",{class:"eye-btn"+(S.eyeRadius===e?" on":""),onClick:()=>{update({eyeRadius:e});triggerQR();}},EYE_LABELS[e]))
    ),
    needsStyling ? h("div",{class:"qz-notice",style:"margin-top:12px"},
      h("strong",{},"Styled mode: "),
      "Using full styling library. Square modules + square eyes uses the fast encoder (~8Ã— faster generation)."
    ) : null
  );
}

function rColorsTab(){
  const cRow=(label,val,onChange)=>h("div",{class:"c-row"},
    h("span",{class:"c-lbl"},label),
    h("div",{class:"c-ctrl"},
      h("div",{class:"swatch",style:{background:val}},
        h("input",{type:"color",value:val,onInput:e=>{onChange(e.target.value);triggerQR();}})
      ),
      h("input",{type:"text",class:"hex",value:val,
        onInput:e=>{if(/^#[0-9a-fA-F]{0,6}$/.test(e.target.value)){onChange(e.target.value);triggerQR();}}
      })
    )
  );
  return h("div",{},
    h("div",{class:"lbl"},"Templates"),
    h("div",{class:"tpl-row"},
      TEMPLATES.map(t=>h("button",{class:"tpl",onClick:()=>{update({bgColor:t.bg,fgColor:t.fg,useGrad:false});triggerQR();}},
        h("div",{style:{width:"12px",height:"12px",borderRadius:"3px",background:t.fg,flexShrink:"0"}}),t.name
      ))
    ),
    cRow("Foreground",S.fgColor,v=>update({fgColor:v})),
    cRow("Background",S.bgColor,v=>update({bgColor:v})),
    // Gradient â€” hard gate
    h("div",{class:"tog-row"},
      tog(S.useGrad,()=>{
        if(!S.useGrad){
          const ratio=cr(S.fgColor,S.bgColor);
          if(ratio<5){
            toast("Gradient warning: contrast "+ratio.toFixed(1)+":1 may fail on phone cameras","wn",4000);
          }
        }
        update({useGrad:!S.useGrad}); triggerQR();
      }),
      h("span",{class:"tog-lbl",onClick:()=>{update({useGrad:!S.useGrad});triggerQR();}},"Gradient mode")
    ),
    S.useGrad ? h("div",{},
      cRow("Gradient End",S.gradEnd,v=>update({gradEnd:v})),
      h("div",{class:"grad-warn"},
        h("strong",{},"âš  Gradient camera risk: "),
        "Variable dot luminance confuses phone camera decoders. Use solid foreground for reliable scans. If contrast ratio is below 5:1, many cameras will fail in normal lighting.",
        h("button",{class:"btn-grad-off",onClick:()=>{update({useGrad:false});triggerQR();}},"â†’ Switch to solid (recommended)")
      )
    ) : null
  );
}

function rAdvancedTab(status, rawData){
  const effEC=QRC.clampEC(S.ecLevel,S.logoSrc,S.logoSize);
  const dc={good:"var(--a)",caution:"var(--warn)",bad:"var(--danger)"};
  const si={good:"âœ“",caution:"âš ",bad:"âœ•"};

  const dpiResult = S.hasQR ? calcDPI(S.qrVersion, S.printSize, S.printDPI) : null;

  return h("div",{},
    h("div",{class:"lbl"},"Error Correction"),
    h("div",{class:"ec-row"},
      EC_LEVELS.map(l=>{
        const isSelected=S.ecLevel===l;
        const isClamped=effEC!==S.ecLevel&&l===effEC;
        return h("button",{
          class:"ecb"+(isSelected?" on":"")+(isClamped&&!isSelected?" clamped":""),
          title:isClamped&&!isSelected?"Auto-upgraded by logo requirement":"",
          onClick:()=>{update({ecLevel:l});triggerQR();}
        },l+(isClamped&&!isSelected?"â†‘":""));
      })
    ),
    h("div",{class:"ec-hint"},"L 7%  M 15%  Q 25%  H 30% â€” H recommended for styled QR"),

    h("div",{class:"lbl"},"Logo / Icon"),
    S.logoSrc
      ? h("div",{class:"logo-prev"},
          h("img",{class:"logo-img",src:S.logoSrc}),
          h("div",{style:"flex:1"},
            h("div",{style:"font-size:11px;color:var(--mut);margin-bottom:5px"},`Size: ${S.logoSize}%`),
            h("input",{type:"range",min:10,max:35,value:S.logoSize,style:"width:100%",onInput:e=>{update({logoSize:+e.target.value});triggerQR();}})
          ),
          h("button",{class:"logo-rm",onClick:()=>{update({logoSrc:null,logoSize:20});triggerQR();}},"Ã—")
        )
      : h("button",{class:"logo-up",onClick:()=>document.getElementById("logo-inp")?.click()},
          h("span",{style:"font-size:20px"},"â¬†"),
          h("span",{style:"font-size:13px;font-weight:600"},"Upload Logo"),
          h("span",{style:"font-size:10px;color:rgba(184,244,0,.35)"},"Use H error correction with logos")
        ),
    h("input",{id:"logo-inp",type:"file",accept:"image/*",style:"display:none",
      onChange:e=>{
        const file=e.target.files?.[0];if(!file)return;
        const r=new FileReader();
        r.onload=ev=>{update({logoSrc:ev.target.result,ecLevel:"H"});triggerQR();};
        r.readAsDataURL(file);
      }
    }),

    h("div",{style:"margin-top:14px;display:flex;align-items:center;gap:9px;margin-bottom:16px"},
      tog(S.hasMargin,()=>{update({hasMargin:!S.hasMargin});triggerQR();}),
      h("span",{class:"tog-lbl",onClick:()=>{update({hasMargin:!S.hasMargin});triggerQR();}},"Quiet zone margin")
    ),

    h("div",{class:"qz-notice"},
      h("strong",{},"Quiet zone: "),
      S.hasQR
        ? `${quietZonePx(S.qrVersion, Math.max(400,400*(Math.min(window.devicePixelRatio||1,3))))}px at current res (4 module widths for v${S.qrVersion})`
        : "4 module widths (proportional to QR version) â€” do not disable"
    ),

    // Print DPI calculator
    h("div",{class:"dpi-wrap"},
      h("div",{class:"dpi-title"},"â—ˆ Print Readability"),
      h("div",{class:"dpi-row"},
        h("div",{},
          h("div",{class:"lbl"},"Print size (in)"),
          h("input",{type:"number",value:S.printSize,min:0.5,max:24,step:0.5,
            onInput:e=>{update({printSize:parseFloat(e.target.value)||2});}
          })
        ),
        h("div",{},
          h("div",{class:"lbl"},"DPI"),
          h("input",{type:"number",value:S.printDPI,min:72,max:1200,step:1,
            onInput:e=>{update({printDPI:parseInt(e.target.value)||300});}
          })
        )
      ),
      dpiResult ? h("div",{class:"dpi-result "+dpiResult.level},dpiResult.msg) : h("div",{class:"dpi-result",style:"color:rgba(255,255,255,.2);font-size:10px"},"Generate a QR to see print analysis")
    ),

    // Scan readiness
    h("div",{class:"scan-box "+status.level},
      h("div",{class:"scan-hdr"},
        h("div",{class:"scan-dot",style:{background:dc[status.level]}}),
        h("div",{class:"scan-title",style:{color:dc[status.level]}},status.label)
      ),
      status.reasons.length>0
        ? h("div",{class:"scan-items"},
            status.reasons.map(r=>h("div",{class:"scan-item"},
              h("span",{style:{color:r.sev==="bad"?"var(--danger)":"var(--warn)",flexShrink:"0"}},si[r.sev]),
              h("span",{},r.msg)
            ))
          )
        : h("div",{class:"scan-item"},h("span",{style:"color:var(--a);flex-shrink:0"},"âœ“"),h("span",{},"No camera readability issues detected"))
    )
  );
}

function rBatchTab(){
  return h("div",{},
    h("div",{class:"sec-label"},"â—ˆ Batch CSV â†’ ZIP"),
    h("div",{style:"font-size:11px;color:rgba(255,255,255,.25);margin-bottom:12px;line-height:1.6"},
      "CSV format: ",h("span",{style:"color:rgba(184,244,0,.5);font-family:'Space Mono',monospace"},"label,url"),
      " â€” one QR per row. Uses current color/EC settings."
    ),
    h("button",{class:"batch-drop",onClick:()=>document.getElementById("batch-inp")?.click()},
      h("span",{class:"ico"},"ðŸ“‹"),
      h("span",{class:"txt"},"Click to upload CSV"),
      h("span",{class:"sub"},"label,url â€” one per line")
    ),
    h("input",{id:"batch-inp",type:"file",accept:".csv,text/csv",style:"display:none",
      onChange:async e=>{
        const file=e.target.files?.[0];if(!file)return;
        const text=await file.text();
        e.target.value="";
        runBatch(text);
      }
    }),
    // Also allow pasting CSV directly
    h("div",{style:"margin-top:10px"},
      h("div",{class:"lbl"},"Or paste CSV"),
      h("textarea",{placeholder:"homepage,https://example.com\nshop,https://shop.example.com",style:"min-height:80px",
        onBlur:e=>{if(e.target.value.trim()){runBatch(e.target.value);e.target.value="";}}
      })
    ),
    S.batchProgress ? h("div",{class:"batch-progress"},
      h("div",{class:"batch-txt"},`Generating ${S.batchProgress.done} / ${S.batchProgress.total}â€¦`),
      h("div",{class:"batch-bar-wrap"},
        h("div",{class:"batch-bar",style:{width:`${Math.round(S.batchProgress.done/S.batchProgress.total*100)}%`}})
      )
    ) : null,
    S.batchBlob ? h("div",{class:"batch-progress"},
      h("div",{class:"batch-txt",style:"color:rgba(184,244,0,.7)"},"âœ“ ZIP ready â€” click to download"),
      h("button",{class:"batch-dl",onClick:downloadBatch},"â¬‡ Download ZIP")
    ) : null
  );
}

function rQRStats(rawData){
  if(!S.hasQR||!rawData.trim()) return null;
  const byteLen = new TextEncoder().encode(rawData).length;
  const effEC = QRC.clampEC(S.ecLevel,S.logoSrc,S.logoSize);
  const maxCap = QR_CAP[effEC]?.[S.qrVersion-1]||0;
  const pct = maxCap ? Math.round(byteLen/maxCap*100) : 0;

  const vClass = S.qrVersion>25?"bad":S.qrVersion>15?"warn":"";
  const pClass = pct>90?"bad":pct>70?"warn":"";

  return h("div",{class:"qr-stats"},
    h("div",{class:`stat-chip ${vClass}`},"Version ",h("span",{class:"sv"},"v"+S.qrVersion)),
    h("div",{class:`stat-chip ${pClass}`},"Capacity ",h("span",{class:"sv"},pct+"%")),
    h("div",{class:"stat-chip"},"Bytes ",h("span",{class:"sv"},byteLen)),
    h("div",{class:"stat-chip"},h("span",{class:"sv"},effEC)," EC"),
    S.finderOk===false ? h("div",{class:"stat-chip bad"},h("span",{class:"sv"},"âš ")," finder") : null,
    S.finderOk===true  ? h("div",{class:"stat-chip"},h("span",{class:"sv"},"âœ“")," finder") : null,
  );
}

function rPreviewPanel(rawData){
  const hasData=!!rawData.trim();
  const hasQR=S.hasQR;

  // Update persistent QR_MOUNT
  QR_MOUNT.className=(!hasData?"qr-mount empty":"qr-mount")+
    (S.verifyStatus==="pass"?" pass":S.verifyStatus==="fail"?" fail":"")+
    (S.lowlight?" lowlight":"");
  QR_MOUNT.style.background=hasData?S.bgColor:"";

  let hint=QR_MOUNT.querySelector(".empty-hint");
  if(!hasData){
    if(!hint){hint=document.createElement("div");hint.className="empty-hint";hint.innerHTML=`<div class="big">â–£</div><div class="txt">Enter data to generate</div>`;const sl=QR_MOUNT.querySelector(".scanline-wrap");if(sl)sl.remove();QR_MOUNT.appendChild(hint);}
  } else { if(hint)hint.remove(); }

  let slWrap=QR_MOUNT.querySelector(".scanline-wrap");
  if(S.verifyStatus==="checking"||S.verifyStatus==="loading"){
    if(!slWrap){slWrap=document.createElement("div");slWrap.className="scanline-wrap";slWrap.innerHTML=`<div class="scanline"></div>`;QR_MOUNT.appendChild(slWrap);}
  } else { if(slWrap)slWrap.remove(); }

  return h("div",{class:"sec"},
    h("div",{class:"prev-hdr"},
      h("div",{class:"prev-title"},"â—ˆ Preview"),
      null // badge injected by updateVerifyBadge()
    ),
    h("div",{id:"qr-mount-slot"}),
    rQRStats(rawData),
    hasData&&hasQR ? h("div",{},
      h("button",{
        class:"btn-ll"+(S.lowlight?" on":""),
        onClick:()=>update({lowlight:!S.lowlight}),
        title:"Simulate low-light / bad camera phone worst case"
      },S.lowlight?"ðŸ”† Low-light ON â€” click to disable":"ðŸŒ‘ Simulate low-light camera"),
      h("div",{class:"dl-row"},
        h("button",{class:"btn-main",onClick:()=>dlQR("png")},"â¬‡ Download PNG"),
        h("button",{class:"btn-out",onClick:()=>dlQR("svg")},"â¬‡ SVG")
      ),
      h("div",{class:"cp-row"},
        h("button",{class:"btn-g"+(S.imgCopied?" done":""),onClick:copyImg},S.imgCopied?"âœ“ Copied!":"âŽ˜ Copy Image"),
        h("button",{class:"btn-g"+(S.dataCopied?" done":""),onClick:()=>copyData(rawData)},S.dataCopied?"âœ“ Copied!":"âŽ˜ Copy Data")
      ),
      h("div",{class:"data-chip"},h("span",{style:"color:var(--a)"},"â–¶ "),rawData),
      h("div",{class:"cam-tip"},"ðŸ“± Point phone camera directly at QR â€” most native cameras decode without an app")
    ) : null
  );
}

function rCustomize(status, rawData){
  return h("div",{class:"sec"},
    h("div",{class:"sec-label"},"â—ˆ Customize"),
    h("div",{class:"ctabs"},
      ["style","colors","advanced","batch"].map(id=>h("button",{
        class:"ctab"+(S.customTab===id?" on":""),
        onClick:()=>update({customTab:id})
      },id[0].toUpperCase()+id.slice(1)))
    ),
    S.customTab==="style"    ? rStyleTab() : null,
    S.customTab==="colors"   ? rColorsTab() : null,
    S.customTab==="advanced" ? rAdvancedTab(status, rawData) : null,
    S.customTab==="batch"    ? rBatchTab() : null,
  );
}

/* â”€â”€ Main render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let _prevRenderSig=null;
function render(){
  const root=document.getElementById("root"); if(!root)return;

  const rawData=buildData(S.qrType,S.fields);
  const hasData=!!rawData.trim();
  const byteLen=new TextEncoder().encode(rawData).length;
  const status=scanStatus(S.fgColor,S.bgColor,S.ecLevel,S.logoSrc?S.logoSize:0,byteLen,S.hasMargin,S.useGrad,S.qrVersion,S.finderOk);

  const uiSig=[S.qrType,S.customTab,S.dotType,S.eyeRadius,S.fgColor,S.bgColor,S.useGrad,S.gradEnd,S.ecLevel,S.logoSrc?"y":"n",S.logoSize,S.hasMargin,status.level,hasData,S.hasQR,S.qrVersion,S.finderOk,S.printSize,S.printDPI,S.lowlight,S.batchProgress?"y":"n",S.batchBlob?"y":"n",Object.keys(S.fieldErrs).join(",")].join("|");
  const shouldRebuild=uiSig!==_prevRenderSig;

  // Always-cheap updates
  QR_MOUNT.className=(!hasData?"qr-mount empty":"qr-mount")+
    (S.verifyStatus==="pass"?" pass":S.verifyStatus==="fail"?" fail":"")+
    (S.lowlight?" lowlight":"");
  QR_MOUNT.style.background=hasData?S.bgColor:"";
  let slWrap=QR_MOUNT.querySelector(".scanline-wrap");
  if(S.verifyStatus==="checking"||S.verifyStatus==="loading"){
    if(!slWrap){slWrap=document.createElement("div");slWrap.className="scanline-wrap";slWrap.innerHTML=`<div class="scanline"></div>`;QR_MOUNT.appendChild(slWrap);}
  } else { if(slWrap)slWrap.remove(); }
  let hint=QR_MOUNT.querySelector(".empty-hint");
  if(!hasData){if(!hint){hint=document.createElement("div");hint.className="empty-hint";hint.innerHTML=`<div class="big">â–£</div><div class="txt">Enter data to generate</div>`;QR_MOUNT.appendChild(hint);}}else{if(hint)hint.remove();}

  updateVerifyBadge();
  if(!shouldRebuild)return;
  _prevRenderSig=uiSig;

  const tree=document.createElement("div");
  tree.appendChild(rHeader());
  const mainDiv=document.createElement("div"); mainDiv.className="main";
  const gridDiv=document.createElement("div"); gridDiv.className="grid";

  const leftCol=document.createElement("div");
  const typeSec=document.createElement("div"); typeSec.className="sec";
  typeSec.appendChild(rTypeSelector());
  leftCol.appendChild(typeSec);

  const formSec=document.createElement("div"); formSec.className="sec"; formSec.style.marginTop="14px";
  const formLabel=document.createElement("div"); formLabel.className="sec-label"; formLabel.textContent="â—ˆ Content";
  formSec.appendChild(formLabel); formSec.appendChild(FORM_EL);
  leftCol.appendChild(formSec);
  leftCol.appendChild(rCustomize(status, rawData));
  gridDiv.appendChild(leftCol);

  const rightCol=document.createElement("div"); rightCol.className="preview-wrap";
  rightCol.appendChild(rPreviewPanel(rawData));
  gridDiv.appendChild(rightCol);

  mainDiv.appendChild(gridDiv);
  tree.appendChild(mainDiv);

  root.innerHTML="";
  while(tree.firstChild)root.appendChild(tree.firstChild);

  const slot=document.getElementById("qr-mount-slot");
  if(slot)slot.replaceWith(QR_MOUNT);

  buildForm(FORM_EL);
  updateVerifyBadge();
}

function updateVerifyBadge(){
  const prevHdr=document.querySelector(".prev-hdr"); if(!prevHdr)return;
  let badge=prevHdr.querySelector(".vbadge");
  if(S.verifyStatus===null){ if(badge)badge.remove(); }
  else{
    if(!badge){badge=document.createElement("span");prevHdr.appendChild(badge);}
    if     (S.verifyStatus==="loading") {badge.className="vbadge loading"; badge.textContent="âŸ³ loading verifierâ€¦";}
    else if(S.verifyStatus==="checking"){badge.className="vbadge checking";badge.textContent="âŸ³ verifyingâ€¦";}
    else if(S.verifyStatus==="pass")    {badge.className="vbadge pass";    badge.textContent="âœ“ canvas decoded";}
    else if(S.verifyStatus==="fail")    {badge.className="vbadge fail";    badge.textContent="âš  verify failed";}
  }

  const mountEl=document.getElementById("qr-mount"); if(!mountEl)return;
  let disc=document.getElementById("verify-disclaimer");
  if(S.verifyStatus==="pass"){
    if(!disc){
      disc=document.createElement("div"); disc.id="verify-disclaimer";
      disc.style.cssText="font-size:10px;color:rgba(255,255,255,.18);text-align:center;margin-bottom:10px;font-family:'Space Mono',monospace;line-height:1.5;padding:0 4px";
      disc.textContent="Canvas decoded OK. Real scan depends on print quality + lighting.";
      mountEl.insertAdjacentElement("afterend",disc);
    }
  } else { if(disc)disc.remove(); }
}

/* â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
render();
buildForm(FORM_EL);
if(Object.keys(S.fields).length>0) triggerQR();
</script>
</body>
</html>

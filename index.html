<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ORBIS â€” Circular Code Generator v3.0</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600&display=swap');

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --ink:     #0a0a0f;
    --paper:   #f5f2eb;
    --accent:  #1a1aff;
    --mid:     #3d3d8a;
    --muted:   #8a8a9a;
    --border:  #d8d4c8;
    --warm:    #fff8f0;
    --scan:    #ff3b00;
    --ok:      #00c853;
  }

  html, body {
    height: 100%;
    background: var(--paper);
    color: var(--ink);
    font-family: 'DM Sans', sans-serif;
    font-weight: 400;
  }

  .shell {
    min-height: 100vh;
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: auto 1fr auto;
  }

  header {
    grid-column: 1 / -1;
    display: flex;
    align-items: baseline;
    gap: 1.5rem;
    padding: 2rem 3rem 1.5rem;
    border-bottom: 1px solid var(--border);
  }
  .logo-word {
    font-family: 'DM Serif Display', serif;
    font-size: 2.2rem;
    letter-spacing: -0.02em;
    color: var(--ink);
    line-height: 1;
  }
  .logo-word em { color: var(--accent); font-style: italic; }
  .tagline {
    font-size: 0.8rem;
    color: var(--muted);
    letter-spacing: 0.08em;
    text-transform: uppercase;
    font-weight: 500;
    padding-top: 0.15rem;
  }
  .version-badge {
    margin-left: auto;
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    color: var(--ok);
    border: 1px solid var(--ok);
    padding: 0.25rem 0.6rem;
    border-radius: 2px;
    letter-spacing: 0.06em;
  }

  .panel-left {
    padding: 2.5rem 3rem;
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .field-group { display: flex; flex-direction: column; gap: 0.5rem; }
  .field-label {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    font-weight: 600;
    color: var(--muted);
  }
  .field-label span { color: var(--scan); }

  .url-input {
    width: 100%;
    background: white;
    border: 1.5px solid var(--border);
    border-radius: 4px;
    padding: 0.85rem 1rem;
    font-family: 'DM Mono', monospace;
    font-size: 0.85rem;
    color: var(--ink);
    outline: none;
    transition: border-color 0.2s;
  }
  .url-input:focus { border-color: var(--accent); }
  .url-input::placeholder { color: var(--muted); }

  /* Capacity bar */
  .capacity-indicator {
    background: white;
    border: 1.5px solid var(--border);
    border-radius: 4px;
    padding: 0.75rem 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  .capacity-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
  }
  .capacity-used {
    color: var(--ink);
    font-weight: 600;
  }
  .capacity-auto-badge {
    background: var(--accent);
    color: white;
    padding: 0.2rem 0.5rem;
    border-radius: 3px;
    font-size: 0.65rem;
    letter-spacing: 0.05em;
  }
  .capacity-bar-track {
    height: 8px;
    background: #e0e0e0;
    border-radius: 4px;
    overflow: hidden;
  }
  .capacity-bar-fill {
    height: 100%;
    background: var(--ok);
    border-radius: 4px;
    transition: width 0.3s, background 0.3s;
  }
  .capacity-bar-fill.warning { background: #ff9800; }
  .capacity-bar-fill.error { background: var(--scan); }

  /* Color presets */
  .color-presets {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.5rem;
  }
  .color-preset {
    aspect-ratio: 1;
    border: 2px solid var(--border);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.15s;
    position: relative;
    overflow: hidden;
  }
  .color-preset:hover {
    transform: scale(1.05);
    border-color: var(--accent);
  }
  .color-preset.active {
    border-color: var(--accent);
    border-width: 3px;
  }
  .color-preset-inner {
    width: 100%;
    height: 100%;
    display: flex;
  }
  .color-preset-fg {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
  }
  .color-preset-bg {
    flex: 1;
  }

  .advanced-toggle {
    background: none;
    border: none;
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    cursor: pointer;
    padding: 0.5rem;
    text-align: left;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    transition: color 0.2s;
  }
  .advanced-toggle:hover { color: var(--accent); }

  .advanced-section {
    display: none;
    animation: slideDown 0.3s;
  }
  .advanced-section.visible { display: block; }

  @keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .ring-selector { 
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 0.4rem;
  }
  .ring-btn {
    padding: 0.5rem 0.3rem;
    background: white;
    border: 1.5px solid var(--border);
    border-radius: 4px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.7rem;
    font-weight: 500;
    color: var(--muted);
    cursor: pointer;
    transition: all 0.15s;
    text-align: center;
  }
  .ring-btn:hover { border-color: var(--accent); color: var(--accent); }
  .ring-btn.active {
    background: var(--accent);
    border-color: var(--accent);
    color: white;
  }

  .logo-input {
    width: 100%;
    background: white;
    border: 1.5px solid var(--border);
    border-radius: 4px;
    padding: 0.7rem 0.9rem;
    font-family: 'DM Serif Display', serif;
    font-size: 1.1rem;
    color: var(--ink);
    outline: none;
    transition: border-color 0.2s;
  }
  .logo-input:focus { border-color: var(--accent); }

  .gen-btn {
    width: 100%;
    padding: 1rem;
    background: var(--ink);
    color: white;
    border: none;
    border-radius: 4px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.9rem;
    font-weight: 600;
    letter-spacing: 0.04em;
    cursor: pointer;
    transition: background 0.15s, transform 0.1s;
  }
  .gen-btn:hover { background: var(--accent); }
  .gen-btn:active { transform: scale(0.99); }
  .gen-btn:disabled {
    background: var(--muted);
    cursor: not-allowed;
    opacity: 0.5;
  }

  .dl-row { display: flex; gap: 0.75rem; }
  .dl-btn {
    flex: 1;
    padding: 0.65rem;
    background: white;
    border: 1.5px solid var(--border);
    border-radius: 4px;
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    color: var(--ink);
    cursor: pointer;
    text-align: center;
    transition: all 0.15s;
    text-decoration: none;
    display: block;
  }
  .dl-btn:hover { border-color: var(--ink); }

  .info-box {
    padding: 0.75rem 1rem;
    background: var(--warm);
    border: 1px solid var(--border);
    border-radius: 4px;
    font-family: 'DM Mono', monospace;
    font-size: 0.72rem;
    color: var(--muted);
    line-height: 1.8;
  }
  .info-box strong { color: var(--ink); }
  .info-box.success {
    background: rgba(0, 200, 83, 0.08);
    border-color: rgba(0, 200, 83, 0.25);
    color: var(--ok);
  }

  .panel-right {
    padding: 2.5rem 3rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 1.5rem;
    background: white;
  }

  .orbis-canvas {
    width: 340px;
    height: 340px;
    position: relative;
  }
  .orbis-canvas svg {
    width: 100%;
    height: 100%;
    filter: drop-shadow(0 8px 32px rgba(0,0,0,0.12));
    border-radius: 50%;
    overflow: visible;
  }

  .scan-label {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--muted);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .scan-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--scan); animation: pulse 1.8s ease-in-out infinite; }
  @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.4;transform:scale(0.7)} }

  .empty-state {
    text-align: center;
    color: var(--muted);
  }
  .empty-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.3;
  }
  .empty-state p { font-size: 0.85rem; line-height: 1.6; }

  footer {
    grid-column: 1 / -1;
    padding: 1rem 3rem;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .footer-note {
    font-size: 0.72rem;
    color: var(--muted);
    font-family: 'DM Mono', monospace;
  }
  .footer-link {
    font-size: 0.72rem;
    color: var(--accent);
    text-decoration: none;
    font-family: 'DM Mono', monospace;
  }

  @media (max-width: 720px) {
    .shell { grid-template-columns: 1fr; }
    .panel-left { border-right: none; border-bottom: 1px solid var(--border); padding: 1.5rem; }
    .panel-right { padding: 2rem 1.5rem; }
    header { padding: 1.5rem; flex-wrap: wrap; }
    footer { flex-direction: column; gap: 0.5rem; text-align: center; }
    .orbis-canvas { width: 280px; height: 280px; }
  }
</style>
</head>
<body>

<div class="shell">

  <header>
    <div class="logo-word"><em>O</em>RBIS</div>
    <div class="tagline">Smart circular codes v3.0</div>
    <div class="version-badge">AUTO</div>
  </header>

  <div class="panel-left">

    <div class="field-group">
      <label class="field-label" for="url-input">URL or Text <span>*</span></label>
      <input class="url-input" id="url-input" type="text"
        placeholder="Enter text or URL..."
        value="orbis.design">
    </div>

    <div class="capacity-indicator">
      <div class="capacity-header">
        <span class="capacity-used" id="capacity-text">12 / 15 bytes</span>
        <span class="capacity-auto-badge" id="auto-badge">AUTO: LITE</span>
      </div>
      <div class="capacity-bar-track">
        <div class="capacity-bar-fill" id="capacity-bar" style="width: 80%"></div>
      </div>
    </div>

    <div class="field-group">
      <div class="field-label">Color Style</div>
      <div class="color-presets">
        <div class="color-preset active" data-fg="#0a0a0f" data-bg="#f5f2eb" title="Classic (Black on Cream)">
          <div class="color-preset-inner">
            <div class="color-preset-fg" style="background: #f5f2eb; color: #0a0a0f;">â—</div>
            <div class="color-preset-bg" style="background: #0a0a0f;"></div>
          </div>
        </div>
        <div class="color-preset" data-fg="#1a1aff" data-bg="#ffffff" title="Blue (High Contrast)">
          <div class="color-preset-inner">
            <div class="color-preset-fg" style="background: #ffffff; color: #1a1aff;">â—</div>
            <div class="color-preset-bg" style="background: #1a1aff;"></div>
          </div>
        </div>
        <div class="color-preset" data-fg="#000000" data-bg="#ffffff" title="Pure (Black & White)">
          <div class="color-preset-inner">
            <div class="color-preset-fg" style="background: #ffffff; color: #000000;">â—</div>
            <div class="color-preset-bg" style="background: #000000;"></div>
          </div>
        </div>
        <div class="color-preset" data-fg="#00c853" data-bg="#0a0a0f" title="Tech (Green on Dark)">
          <div class="color-preset-inner">
            <div class="color-preset-fg" style="background: #0a0a0f; color: #00c853;">â—</div>
            <div class="color-preset-bg" style="background: #00c853;"></div>
          </div>
        </div>
      </div>
    </div>

    <button class="advanced-toggle" id="advanced-toggle">â–¼ Advanced Options</button>

    <div class="advanced-section" id="advanced-section">
      <div class="field-group">
        <div class="field-label">Manual Version Override</div>
        <div class="ring-selector">
          <button class="ring-btn" data-version="lite">Lite<br><small>17B</small></button>
          <button class="ring-btn" data-version="standard">Std<br><small>34B</small></button>
          <button class="ring-btn" data-version="pro">Pro<br><small>56B</small></button>
          <button class="ring-btn" data-version="ultra">Ultra<br><small>83B</small></button>
          <button class="ring-btn" data-version="mega">Mega<br><small>117B</small></button>
        </div>
      </div>

      <div class="field-group">
        <label class="field-label" for="logo-input">Centre Logo (1-3 chars)</label>
        <input class="logo-input" id="logo-input" type="text" maxlength="3"
          placeholder="â—" value="â—">
      </div>
    </div>

    <button class="gen-btn" id="gen-btn">Generate ORBIS</button>

    <div class="dl-row">
      <a class="dl-btn" id="dl-svg" href="#" download="orbis.svg">â†“ SVG</a>
      <a class="dl-btn" id="dl-png" href="#" download="orbis.png">â†“ PNG</a>
    </div>

    <div class="info-box success">
      <strong>âœ“ Smart Features Active</strong><br>
      â€¢ Auto version selection<br>
      â€¢ High contrast enforced<br>
      â€¢ White border included
    </div>

    <a href="orbis-scanner-v3.html" style="display:block;width:100%;padding:0.7rem;text-align:center;border:1.5px solid var(--border);border-radius:4px;font-family:'DM Mono',monospace;font-size:0.8rem;color:var(--ink);text-decoration:none;background:white;transition:all 0.15s;" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--ink)'">&#9678; Open Scanner &rarr;</a>

  </div>

  <div class="panel-right">
    <div class="orbis-canvas" id="orbis-canvas">
      <div class="empty-state">
        <div class="empty-icon">â—</div>
        <p>Your ORBIS code<br>will appear here</p>
      </div>
    </div>
    <div class="scan-label">
      <div class="scan-dot"></div>
      Point camera here to scan
    </div>
  </div>

  <footer>
    <span class="footer-note">ORBIS v3.0 â€” Auto-optimized Â· Smart defaults Â· Universal scanning</span>
    <a class="footer-link" href="#" target="_blank">github.com/orbis-code</a>
  </footer>

</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ORBIS GENERATOR V3.0 â€” Smart Defaults & Auto-Optimization
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const VERSIONS = {
  lite:     { rings: 10, sMax: 32, sFloor: 10, dataBytes: 17 },
  standard: { rings: 16, sMax: 40, sFloor: 12, dataBytes: 34 },
  pro:      { rings: 22, sMax: 48, sFloor: 14, dataBytes: 56 },
  ultra:    { rings: 28, sMax: 56, sFloor: 16, dataBytes: 83 },
  mega:     { rings: 35, sMax: 64, sFloor: 18, dataBytes: 117 },
};

function sectorCount(r, rMax, sMax, sFloor) {
  return Math.max(sFloor, Math.round(sMax * r / rMax));
}

// â”€â”€ Auto version selection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function autoSelectVersion(payload) {
  const encoder = new TextEncoder();
  const bytes = encoder.encode(payload).length;
  
  for (const [name, cfg] of Object.entries(VERSIONS)) {
    if (bytes <= cfg.dataBytes - 2) {
      return name;
    }
  }
  return 'mega'; // fallback
}

// â”€â”€ Contrast checker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getLuminance(hex) {
  const rgb = parseInt(hex.slice(1), 16);
  const r = (rgb >> 16) & 0xff;
  const g = (rgb >> 8) & 0xff;
  const b = rgb & 0xff;
  
  const [rs, gs, bs] = [r, g, b].map(c => {
    c = c / 255;
    return c <= 0.03928 ? c / 12.92 : Math.pow((c + 0.055) / 1.055, 2.4);
  });
  
  return 0.2126 * rs + 0.7152 * gs + 0.0722 * bs;
}

function getContrastRatio(hex1, hex2) {
  const l1 = getLuminance(hex1);
  const l2 = getLuminance(hex2);
  const lighter = Math.max(l1, l2);
  const darker = Math.min(l1, l2);
  return (lighter + 0.05) / (darker + 0.05);
}

// â”€â”€ Error correction â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addErrorCorrection(dataBytes, ecLevel = 0.3) {
  const ecBytes = Math.ceil(dataBytes.length * ecLevel);
  const result = new Uint8Array(dataBytes.length + ecBytes);
  result.set(dataBytes, 0);
  
  for (let i = 0; i < ecBytes; i++) {
    let ec = 0;
    for (let j = 0; j < dataBytes.length; j++) {
      ec ^= dataBytes[j] * (i + j + 1);
    }
    result[dataBytes.length + i] = ec & 0xFF;
  }
  
  return result;
}

// â”€â”€ Data encoding â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function encodePayload(payload, maxBytes) {
  const encoder = new TextEncoder();
  const utf8 = encoder.encode(payload);
  
  if (utf8.length > maxBytes - 2) {
    throw new Error(`Payload too long: ${utf8.length} bytes (max ${maxBytes - 2})`);
  }
  
  const result = new Uint8Array(maxBytes);
  result[0] = (utf8.length >> 8) & 0xFF;
  result[1] = utf8.length & 0xFF;
  result.set(utf8, 2);
  
  for (let i = 2 + utf8.length; i < maxBytes; i++) {
    result[i] = (i % 2 === 0) ? 0xEC : 0x11;
  }
  
  return result;
}

// â”€â”€ Bit matrix builder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildBitMatrix(encodedBytes, version) {
  const cfg = VERSIONS[version];
  const { sMax, rings, sFloor } = cfg;
  
  const bits = [];
  for (const byte of encodedBytes) {
    for (let i = 7; i >= 0; i--) {
      bits.push((byte >> i) & 1);
    }
  }
  
  let totalCells = 0;
  const ringCells = [];
  for (let r = 1; r <= rings; r++) {
    const s = sectorCount(r, rings, sMax, sFloor);
    ringCells.push(s);
    totalCells += s;
  }
  
  const versionMarker = { lite: 0b00, standard: 0b01, pro: 0b10, ultra: 0b11, mega: 0b11 }[version];
  bits.unshift((versionMarker >> 1) & 1, versionMarker & 1);
  
  if (version === 'mega') {
    bits.unshift(1);
  } else {
    bits.unshift(0);
  }
  
  while (bits.length < totalCells) {
    bits.push(bits.length % 2);
  }
  
  const matrix = [];
  let idx = 0;
  for (let r = 0; r < rings; r++) {
    const row = [];
    for (let s = 0; s < ringCells[r]; s++) {
      row.push(bits[idx++] || 0);
    }
    matrix.push(row);
  }
  
  return matrix;
}

// â”€â”€ SVG Renderer with WHITE BORDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderORBIS({
  payload = 'orbis.design',
  version  = 'lite',
  fg       = '#0a0a0f',
  bg       = '#f5f2eb',
  logoText = 'â—',
  size     = 400,
}) {
  const cfg = VERSIONS[version];
  const { sMax, rings, sFloor } = cfg;
  
  const encoded = encodePayload(payload, cfg.dataBytes);
  const withEC = addErrorCorrection(encoded, 0.3);
  const matrix = buildBitMatrix(withEC, version);
  
  const cx = size / 2, cy = size / 2;
  const R  = size / 2 - 20; // EXTRA PADDING for white border
  
  const logoR     = R * 0.18;
  const identityR = R * 0.25;
  const dataInR   = R * 0.25;
  const dataOutR  = R * 0.72;
  const ecInR     = R * 0.72;
  const ecOutR    = R * 0.86;
  const scanInR   = R * 0.86;
  const scanOutR  = R;
  
  const ringW = (dataOutR - dataInR) / rings;
  
  let paths = '';
  
  // WHITE BORDER/PADDING (safety margin)
  paths += `<circle cx="${cx}" cy="${cy}" r="${R + 18}" fill="white"/>`;
  
  // Background
  paths += `<circle cx="${cx}" cy="${cy}" r="${R + 2}" fill="${bg}"/>`;
  
  // L5 â€” Outer Scan Ring
  const L5_SEGMENTS = 48;
  for (let i = 0; i < L5_SEGMENTS; i++) {
    const startAngle = (i / L5_SEGMENTS) * 2 * Math.PI - Math.PI / 2;
    const endAngle   = ((i + 0.75) / L5_SEGMENTS) * 2 * Math.PI - Math.PI / 2;
    const path = annularArc(cx, cy, scanInR, scanOutR, startAngle, endAngle);
    const opacity = (i % 6 === 0) ? 1.0 : 0.7;
    paths += `<path d="${path}" fill="${fg}" opacity="${opacity}"/>`;
  }
  
  [0, 120, 240].forEach(deg => {
    const baseRad = (deg - 90) * Math.PI / 180;
    const arcSpan = (3.5 / L5_SEGMENTS) * 2 * Math.PI;
    const a1 = baseRad - arcSpan / 2;
    const a2 = baseRad + arcSpan / 2;
    paths += `<path d="${annularArc(cx, cy, scanInR - 3, scanOutR + 2, a1, a2)}" fill="${fg}"/>`;
  });
  
  // L4 â€” Error Correction
  const EC_DOTS = 60;
  for (let i = 0; i < EC_DOTS; i++) {
    const angle = (i / EC_DOTS) * 2 * Math.PI - Math.PI / 2;
    const rMid  = (ecInR + ecOutR) / 2;
    const x = cx + Math.cos(angle) * rMid;
    const y = cy + Math.sin(angle) * rMid;
    const sz = (i % 4 === 0) ? 2.2 : 1.3;
    paths += `<circle cx="${x.toFixed(2)}" cy="${y.toFixed(2)}" r="${sz}" fill="${fg}" opacity="${i%4===0?0.8:0.4}"/>`;
  }
  
  // L3 â€” Primary Data Rings
  for (let r = 0; r < rings; r++) {
    const innerR = dataInR + r * ringW;
    const outerR = dataInR + (r + 1) * ringW - 0.8;
    const rowBits = matrix[r];
    const numSectors = rowBits.length;
    const angleStep = (2 * Math.PI) / numSectors;
    
    for (let s = 0; s < numSectors; s++) {
      if (rowBits[s] === 0) continue;
      const startAngle = s * angleStep - Math.PI / 2;
      const endAngle   = (s + 1) * angleStep - Math.PI / 2 - 0.015;
      const path = annularArc(cx, cy, innerR, outerR, startAngle, endAngle);
      paths += `<path d="${path}" fill="${fg}" opacity="${0.75 + (r / rings) * 0.25}"/>`;
    }
  }
  
  // L2 â€” Identity Ring
  const ID_NOTCHES = 48;
  for (let i = 0; i < ID_NOTCHES; i++) {
    const a1 = (i / ID_NOTCHES) * 2 * Math.PI - Math.PI / 2;
    const a2 = ((i + 0.7) / ID_NOTCHES) * 2 * Math.PI - Math.PI / 2;
    const innerV = (i % 3 === 0) ? logoR + 1 : logoR + 3;
    paths += `<path d="${annularArc(cx, cy, innerV, identityR - 1, a1, a2)}" fill="${fg}" opacity="${i%3===0?0.9:0.3}"/>`;
  }
  
  // L1 â€” Core Logo
  paths += `<circle cx="${cx}" cy="${cy}" r="${logoR}" fill="${bg}"/>`;
  paths += `<circle cx="${cx}" cy="${cy}" r="${logoR}" fill="none" stroke="${fg}" stroke-width="1.5" opacity="0.6"/>`;
  
  const logoFontSize = logoText.length === 1 ? logoR * 0.85 : logoR * 0.55;
  paths += `<text x="${cx}" y="${cy}" text-anchor="middle" dominant-baseline="central"
    font-family="DM Serif Display, Georgia, serif"
    font-size="${logoFontSize.toFixed(1)}"
    fill="${fg}">${escapeXml(logoText)}</text>`;
  
  paths += `<circle cx="${cx}" cy="${cy}" r="${R}" fill="none" stroke="${fg}" stroke-width="1.5" opacity="0.5"/>`;
  
  return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${size} ${size}" width="${size}" height="${size}">
  <defs>
    <clipPath id="circle-clip">
      <circle cx="${cx}" cy="${cy}" r="${R + 20}"/>
    </clipPath>
  </defs>
  <g clip-path="url(#circle-clip)">
    ${paths}
  </g>
</svg>`;
}

function annularArc(cx, cy, innerR, outerR, startAngle, endAngle) {
  const x1 = cx + Math.cos(startAngle) * outerR;
  const y1 = cy + Math.sin(startAngle) * outerR;
  const x2 = cx + Math.cos(endAngle)   * outerR;
  const y2 = cy + Math.sin(endAngle)   * outerR;
  const x3 = cx + Math.cos(endAngle)   * innerR;
  const y3 = cy + Math.sin(endAngle)   * innerR;
  const x4 = cx + Math.cos(startAngle) * innerR;
  const y4 = cy + Math.sin(startAngle) * innerR;
  const large = (endAngle - startAngle) > Math.PI ? 1 : 0;
  return [
    `M ${x1.toFixed(2)} ${y1.toFixed(2)}`,
    `A ${outerR.toFixed(2)} ${outerR.toFixed(2)} 0 ${large} 1 ${x2.toFixed(2)} ${y2.toFixed(2)}`,
    `L ${x3.toFixed(2)} ${y3.toFixed(2)}`,
    `A ${innerR.toFixed(2)} ${innerR.toFixed(2)} 0 ${large} 0 ${x4.toFixed(2)} ${y4.toFixed(2)}`,
    'Z'
  ].join(' ');
}

function escapeXml(s) {
  return String(s)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UI CONTROLLER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let currentSvg = '';
let currentFg = '#0a0a0f';
let currentBg = '#f5f2eb';
let manualVersion = null;

function getInputs() {
  const payload = document.getElementById('url-input').value.trim() || 'orbis.design';
  const version = manualVersion || autoSelectVersion(payload);
  
  return {
    payload,
    version,
    fg: currentFg,
    bg: currentBg,
    logoText: document.getElementById('logo-input').value.trim() || 'â—',
    size: 400,
  };
}

function updateCapacityIndicator() {
  const payload = document.getElementById('url-input').value.trim() || '';
  const encoder = new TextEncoder();
  const bytes = encoder.encode(payload).length;
  
  const version = manualVersion || autoSelectVersion(payload);
  const cfg = VERSIONS[version];
  const maxBytes = cfg.dataBytes - 2;
  
  const percentage = Math.min(100, (bytes / maxBytes) * 100);
  
  document.getElementById('capacity-text').textContent = `${bytes} / ${maxBytes} bytes`;
  document.getElementById('auto-badge').textContent = manualVersion ? `MANUAL: ${version.toUpperCase()}` : `AUTO: ${version.toUpperCase()}`;
  
  const bar = document.getElementById('capacity-bar');
  bar.style.width = percentage + '%';
  bar.className = 'capacity-bar-fill';
  
  if (percentage > 100) {
    bar.classList.add('error');
  } else if (percentage > 85) {
    bar.classList.add('warning');
  }
  
  // Update generate button
  document.getElementById('gen-btn').disabled = bytes > maxBytes;
}

function generate() {
  const inputs = getInputs();
  
  try {
    currentSvg = renderORBIS(inputs);
    const canvas = document.getElementById('orbis-canvas');
    canvas.innerHTML = currentSvg;
    updateDownloads(inputs.payload);
  } catch (err) {
    const encoder = new TextEncoder();
    const bytes = encoder.encode(inputs.payload).length;
    const cfg = VERSIONS[inputs.version];
    const maxAllowed = cfg.dataBytes - 2;
    
    alert(`âŒ ${err.message}\n\nYour text: "${inputs.payload}"\nSize: ${bytes} bytes\nMax allowed: ${maxAllowed} bytes\n\nğŸ’¡ Try a shorter version or upgrade to a bigger size.`);
  }
}

function updateDownloads(payload) {
  // Smart filename
  let filename = 'orbis';
  if (payload) {
    const slug = payload
      .replace(/^https?:\/\//, '')
      .replace(/[^a-z0-9]/gi, '-')
      .replace(/-+/g, '-')
      .replace(/^-|-$/g, '')
      .slice(0, 30);
    filename = 'orbis-' + (slug || 'code');
  }
  
  const svgBlob = new Blob([currentSvg], { type: 'image/svg+xml' });
  const svgUrl = URL.createObjectURL(svgBlob);
  const dlSvg = document.getElementById('dl-svg');
  dlSvg.href = svgUrl;
  dlSvg.download = filename + '.svg';
  
  const svgEl = document.getElementById('orbis-canvas').querySelector('svg');
  const canvas = document.createElement('canvas');
  canvas.width = 800;
  canvas.height = 800;
  const ctx = canvas.getContext('2d');
  const img = new Image();
  const blob = new Blob([currentSvg], { type: 'image/svg+xml;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  img.onload = () => {
    ctx.drawImage(img, 0, 0, 800, 800);
    URL.revokeObjectURL(url);
    const dlPng = document.getElementById('dl-png');
    dlPng.href = canvas.toDataURL('image/png');
    dlPng.download = filename + '.png';
  };
  img.src = url;
}

// â”€â”€ Event bindings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('gen-btn').addEventListener('click', generate);

document.getElementById('url-input').addEventListener('input', () => {
  updateCapacityIndicator();
  // Live preview with debounce
  clearTimeout(window.livePreviewTimeout);
  window.livePreviewTimeout = setTimeout(generate, 500);
});

document.getElementById('url-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') generate();
});

// Color presets
document.querySelectorAll('.color-preset').forEach(preset => {
  preset.addEventListener('click', () => {
    document.querySelectorAll('.color-preset').forEach(p => p.classList.remove('active'));
    preset.classList.add('active');
    
    currentFg = preset.dataset.fg;
    currentBg = preset.dataset.bg;
    
    generate();
  });
});

// Advanced toggle
document.getElementById('advanced-toggle').addEventListener('click', () => {
  const section = document.getElementById('advanced-section');
  const toggle = document.getElementById('advanced-toggle');
  
  if (section.classList.contains('visible')) {
    section.classList.remove('visible');
    toggle.textContent = 'â–¼ Advanced Options';
  } else {
    section.classList.add('visible');
    toggle.textContent = 'â–² Advanced Options';
  }
});

// Manual version override
document.querySelectorAll('.ring-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.ring-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    manualVersion = btn.dataset.version;
    updateCapacityIndicator();
  });
});

window.addEventListener('load', () => {
  updateCapacityIndicator();
  generate();
});
</script>
</body>
</html>
